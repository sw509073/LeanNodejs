{"version":3,"file":"index.js","sources":["../../src/GrowthBookReact.tsx"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport * as React from \"react\";\nimport type {\n  Experiment,\n  Result,\n  FeatureResult,\n  JSONValue,\n  FeatureDefinition,\n  Context,\n  WidenPrimitives,\n} from \"@growthbook/growthbook\";\nimport { GrowthBook } from \"@growthbook/growthbook\";\n\nexport type GrowthBookContextValue = {\n  growthbook?: GrowthBook;\n};\nexport interface WithRunExperimentProps {\n  runExperiment: <T>(exp: Experiment<T>) => Result<T>;\n}\nexport type GrowthBookSSRData = {\n  attributes: Record<string, any>;\n  features: Record<string, FeatureDefinition>;\n};\n\nexport const GrowthBookContext = React.createContext<GrowthBookContextValue>(\n  {}\n);\n\nfunction run<T>(exp: Experiment<T>, growthbook?: GrowthBook): Result<T> {\n  if (!growthbook) {\n    return {\n      featureId: null,\n      value: exp.variations[0],\n      variationId: 0,\n      inExperiment: false,\n      hashUsed: false,\n      hashAttribute: exp.hashAttribute || \"id\",\n      hashValue: \"\",\n      key: \"\",\n    };\n  }\n  return growthbook.run(exp);\n}\nfunction feature<T extends JSONValue = any>(\n  id: string,\n  growthbook?: GrowthBook\n): FeatureResult<T | null> {\n  if (!growthbook) {\n    return {\n      value: null,\n      on: false,\n      off: true,\n      source: \"unknownFeature\",\n      ruleId: \"\",\n    };\n  }\n  return growthbook.evalFeature<T>(id);\n}\n\n// Get features from API and targeting attributes during SSR\nexport async function getGrowthBookSSRData(\n  context: Context\n): Promise<GrowthBookSSRData> {\n  // Server-side GrowthBook instance\n  const gb = new GrowthBook({\n    ...context,\n  });\n\n  // Load feature flags from network if needed\n  if (context.clientKey) {\n    await gb.loadFeatures();\n  }\n\n  const data: GrowthBookSSRData = {\n    attributes: gb.getAttributes(),\n    features: gb.getFeatures(),\n  };\n  gb.destroy();\n\n  return data;\n}\n\n// Populate the GrowthBook instance in context from the SSR props\nexport function useGrowthBookSSR(data: GrowthBookSSRData) {\n  const gb = useGrowthBook();\n\n  // Only do this once to avoid infinite loops\n  const isFirst = React.useRef(true);\n  if (gb && isFirst.current) {\n    gb.setFeatures(data.features);\n    gb.setAttributes(data.attributes);\n    isFirst.current = false;\n  }\n}\n\nexport function useExperiment<T>(exp: Experiment<T>): Result<T> {\n  const { growthbook } = React.useContext(GrowthBookContext);\n  return run(exp, growthbook);\n}\n\nexport function useFeature<T extends JSONValue = any>(\n  id: string\n): FeatureResult<T | null> {\n  const growthbook = useGrowthBook();\n  return feature(id, growthbook);\n}\n\nexport function useFeatureIsOn<\n  AppFeatures extends Record<string, any> = Record<string, any>\n>(id: string & keyof AppFeatures): boolean {\n  const growthbook = useGrowthBook<AppFeatures>();\n  return growthbook ? growthbook.isOn(id) : false;\n}\n\nexport function useFeatureValue<T extends JSONValue = any>(\n  id: string,\n  fallback: T\n): WidenPrimitives<T> {\n  const growthbook = useGrowthBook();\n  return growthbook\n    ? growthbook.getFeatureValue(id, fallback)\n    : (fallback as WidenPrimitives<T>);\n}\n\nexport function useGrowthBook<\n  AppFeatures extends Record<string, any> = Record<string, any>\n>(): GrowthBook<AppFeatures> | undefined {\n  const { growthbook } = React.useContext(GrowthBookContext);\n  return growthbook as GrowthBook<AppFeatures> | undefined;\n}\n\nexport function FeaturesReady({\n  children,\n  timeout,\n  fallback,\n}: {\n  children: React.ReactNode;\n  timeout?: number;\n  fallback?: React.ReactNode;\n}) {\n  const gb = useGrowthBook();\n  const [ready, setReady] = React.useState(gb ? gb.ready : false);\n  React.useEffect(() => {\n    if (timeout && !ready) {\n      const timer = setTimeout(() => {\n        setReady(true);\n      }, timeout);\n      return () => clearTimeout(timer);\n    }\n  }, [timeout, ready]);\n\n  return ready ? children : fallback || null;\n}\n\nexport function IfFeatureEnabled({\n  children,\n  feature,\n}: {\n  children: React.ReactNode;\n  feature: string;\n}) {\n  return useFeature(feature).on ? <>{children}</> : null;\n}\n\nexport function FeatureString(props: { default: string; feature: string }) {\n  const value = useFeature(props.feature).value;\n\n  if (value !== null) {\n    return <>{value}</>;\n  }\n\n  return <>{props.default}</>;\n}\n\nexport const withRunExperiment = <P extends WithRunExperimentProps>(\n  Component: React.ComponentType<P>\n): React.ComponentType<Omit<P, keyof WithRunExperimentProps>> => {\n  // eslint-disable-next-line\n  const withRunExperimentWrapper = (props: any): JSX.Element => (\n    <GrowthBookContext.Consumer>\n      {({ growthbook }): JSX.Element => {\n        return (\n          <Component\n            {...(props as P)}\n            runExperiment={(exp) => run(exp, growthbook)}\n          />\n        );\n      }}\n    </GrowthBookContext.Consumer>\n  );\n  return withRunExperimentWrapper;\n};\nwithRunExperiment.displayName = \"WithRunExperiment\";\n\nexport const GrowthBookProvider: React.FC<\n  React.PropsWithChildren<{\n    growthbook?: GrowthBook;\n  }>\n> = ({ children, growthbook }) => {\n  // Tell growthbook how to re-render our app (for dev mode integration)\n  // eslint-disable-next-line\n  const [_, setRenderCount] = React.useState(0);\n  React.useEffect(() => {\n    if (!growthbook || !growthbook.setRenderer) return;\n\n    growthbook.setRenderer(() => {\n      setRenderCount((v) => v + 1);\n    });\n    return () => {\n      growthbook.setRenderer(() => {\n        // do nothing\n      });\n    };\n  }, [growthbook]);\n\n  return (\n    <GrowthBookContext.Provider\n      value={{\n        growthbook,\n      }}\n    >\n      {children}\n    </GrowthBookContext.Provider>\n  );\n};\n"],"names":["GrowthBookContext","React","createContext","run","exp","growthbook","featureId","value","variations","variationId","inExperiment","hashUsed","hashAttribute","hashValue","key","feature","id","on","off","source","ruleId","evalFeature","getGrowthBookSSRData","context","gb","GrowthBook","clientKey","loadFeatures","data","attributes","getAttributes","features","getFeatures","destroy","useGrowthBookSSR","useGrowthBook","isFirst","useRef","current","setFeatures","setAttributes","useExperiment","useContext","useFeature","useFeatureIsOn","isOn","useFeatureValue","fallback","getFeatureValue","FeaturesReady","children","timeout","ready","setReady","useState","useEffect","timer","setTimeout","clearTimeout","IfFeatureEnabled","FeatureString","props","default","withRunExperiment","Component","withRunExperimentWrapper","displayName","GrowthBookProvider","_","setRenderCount","setRenderer","v"],"mappings":"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"}