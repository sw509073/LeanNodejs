{"version":3,"file":"feature-repository.js","names":["cacheSettings","staleTTL","cacheKey","backgroundSync","polyfills","fetch","globalThis","bind","undefined","SubtleCrypto","crypto","subtle","EventSource","localStorage","e","subscribedInstances","Map","cacheInitialized","cache","activeFetches","streams","supportsSSE","Set","setPolyfills","overrides","Object","assign","configureCache","clearAutoRefresh","clearCache","clear","updatePersistentCache","refreshFeatures","instance","timeout","skipCache","allowStale","updateInstance","data","fetchFeaturesWithCache","refreshInstance","subscribe","key","getKey","subs","get","add","set","unsubscribe","forEach","s","delete","setItem","JSON","stringify","Array","from","entries","now","Date","initializeCache","existing","staleAt","fetchFeatures","startAutoRefresh","promiseTimeout","apiHost","clientKey","getApiInfo","promise","Promise","resolve","resolved","timer","finish","clearTimeout","setTimeout","then","catch","value","getItem","parsed","parse","isArray","onNewFeatureData","version","dateUpdated","instances","encryptedExperiments","setEncryptedExperiments","setExperiments","experiments","getExperiments","encryptedFeatures","setEncryptedFeatures","setFeatures","features","getFeatures","endpoint","res","headers","json","process","env","NODE_ENV","log","error","message","has","channel","src","cb","event","errors","onSSEError","enableChannel","readyState","delay","Math","pow","random","disableChannel","min","onopen","onerror","close","addEventListener","destroyChannel"],"sources":["../../src/feature-repository.ts"],"sourcesContent":["import {\n  ApiHost,\n  CacheSettings,\n  ClientKey,\n  FeatureApiResponse,\n  Polyfills,\n  RepositoryKey,\n} from \"./types/growthbook\";\nimport type { GrowthBook } from \".\";\n\ntype CacheEntry = {\n  data: FeatureApiResponse;\n  version: string;\n  staleAt: Date;\n};\ntype ScopedChannel = {\n  src: EventSource | null;\n  cb: (event: MessageEvent<string>) => void;\n  errors: number;\n};\n\n// Config settings\nconst cacheSettings: CacheSettings = {\n  // Consider a fetch stale after 1 minute\n  staleTTL: 1000 * 60,\n  cacheKey: \"gbFeaturesCache\",\n  backgroundSync: true,\n};\nconst polyfills: Polyfills = {\n  fetch: globalThis.fetch ? globalThis.fetch.bind(globalThis) : undefined,\n  SubtleCrypto: globalThis.crypto ? globalThis.crypto.subtle : undefined,\n  EventSource: globalThis.EventSource,\n};\ntry {\n  if (globalThis.localStorage) {\n    polyfills.localStorage = globalThis.localStorage;\n  }\n} catch (e) {\n  // Ignore localStorage errors\n}\n\n// Global state\nconst subscribedInstances: Map<RepositoryKey, Set<GrowthBook>> = new Map();\nlet cacheInitialized = false;\nconst cache: Map<RepositoryKey, CacheEntry> = new Map();\nconst activeFetches: Map<\n  RepositoryKey,\n  Promise<FeatureApiResponse>\n> = new Map();\nconst streams: Map<RepositoryKey, ScopedChannel> = new Map();\nconst supportsSSE: Set<RepositoryKey> = new Set();\n\n// Public functions\nexport function setPolyfills(overrides: Partial<Polyfills>): void {\n  Object.assign(polyfills, overrides);\n}\nexport function configureCache(overrides: Partial<CacheSettings>): void {\n  Object.assign(cacheSettings, overrides);\n  if (!cacheSettings.backgroundSync) {\n    clearAutoRefresh();\n  }\n}\n\nexport async function clearCache(): Promise<void> {\n  cache.clear();\n  activeFetches.clear();\n  clearAutoRefresh();\n  cacheInitialized = false;\n  await updatePersistentCache();\n}\n\nexport async function refreshFeatures(\n  instance: GrowthBook,\n  timeout?: number,\n  skipCache?: boolean,\n  allowStale?: boolean,\n  updateInstance?: boolean\n): Promise<void> {\n  const data = await fetchFeaturesWithCache(\n    instance,\n    allowStale,\n    timeout,\n    skipCache\n  );\n  updateInstance && data && (await refreshInstance(instance, data));\n}\n\n// Subscribe a GrowthBook instance to feature changes\nexport function subscribe(instance: GrowthBook): void {\n  const [key] = getKey(instance);\n  const subs = subscribedInstances.get(key) || new Set();\n  subs.add(instance);\n  subscribedInstances.set(key, subs);\n}\nexport function unsubscribe(instance: GrowthBook): void {\n  subscribedInstances.forEach((s) => s.delete(instance));\n}\n\n// Private functions\nasync function updatePersistentCache() {\n  try {\n    if (!polyfills.localStorage) return;\n    await polyfills.localStorage.setItem(\n      cacheSettings.cacheKey,\n      JSON.stringify(Array.from(cache.entries()))\n    );\n  } catch (e) {\n    // Ignore localStorage errors\n  }\n}\n\nasync function fetchFeaturesWithCache(\n  instance: GrowthBook,\n  allowStale?: boolean,\n  timeout?: number,\n  skipCache?: boolean\n): Promise<FeatureApiResponse | null> {\n  const [key] = getKey(instance);\n  const now = new Date();\n  await initializeCache();\n  const existing = cache.get(key);\n  if (existing && !skipCache && (allowStale || existing.staleAt > now)) {\n    // Reload features in the backgroud if stale\n    if (existing.staleAt < now) {\n      fetchFeatures(instance);\n    }\n    // Otherwise, if we don't need to refresh now, start a background sync\n    else {\n      startAutoRefresh(instance);\n    }\n    return existing.data;\n  } else {\n    const data = await promiseTimeout(fetchFeatures(instance), timeout);\n    return data;\n  }\n}\n\nfunction getKey(instance: GrowthBook): [RepositoryKey, ApiHost, ClientKey] {\n  const [apiHost, clientKey] = instance.getApiInfo();\n  return [`${apiHost}||${clientKey}`, apiHost, clientKey];\n}\n\n// Guarantee the promise always resolves within {timeout} ms\n// Resolved value will be `null` when there's an error or it takes too long\n// Note: The promise will continue running in the background, even if the timeout is hit\nfunction promiseTimeout<T>(\n  promise: Promise<T>,\n  timeout?: number\n): Promise<T | null> {\n  return new Promise((resolve) => {\n    let resolved = false;\n    let timer: unknown;\n    const finish = (data?: T) => {\n      if (resolved) return;\n      resolved = true;\n      timer && clearTimeout(timer as NodeJS.Timer);\n      resolve(data || null);\n    };\n\n    if (timeout) {\n      timer = setTimeout(() => finish(), timeout);\n    }\n\n    promise.then((data) => finish(data)).catch(() => finish());\n  });\n}\n\n// Populate cache from localStorage (if available)\nasync function initializeCache(): Promise<void> {\n  if (cacheInitialized) return;\n  cacheInitialized = true;\n  try {\n    if (polyfills.localStorage) {\n      const value = await polyfills.localStorage.getItem(\n        cacheSettings.cacheKey\n      );\n      if (value) {\n        const parsed: [RepositoryKey, CacheEntry][] = JSON.parse(value);\n        if (parsed && Array.isArray(parsed)) {\n          parsed.forEach(([key, data]) => {\n            cache.set(key, {\n              ...data,\n              staleAt: new Date(data.staleAt),\n            });\n          });\n        }\n      }\n    }\n  } catch (e) {\n    // Ignore localStorage errors\n  }\n}\n\n// Called whenever new features are fetched from the API\nfunction onNewFeatureData(key: RepositoryKey, data: FeatureApiResponse): void {\n  // If contents haven't changed, ignore the update, extend the stale TTL\n  const version = data.dateUpdated || \"\";\n  const staleAt = new Date(Date.now() + cacheSettings.staleTTL);\n  const existing = cache.get(key);\n  if (existing && version && existing.version === version) {\n    existing.staleAt = staleAt;\n    return;\n  }\n\n  // Update in-memory cache\n  cache.set(key, {\n    data,\n    version,\n    staleAt,\n  });\n  // Update local storage (don't await this, just update asynchronously)\n  updatePersistentCache();\n\n  // Update features for all subscribed GrowthBook instances\n  const instances = subscribedInstances.get(key);\n  instances && instances.forEach((instance) => refreshInstance(instance, data));\n}\n\nasync function refreshInstance(\n  instance: GrowthBook,\n  data: FeatureApiResponse\n): Promise<void> {\n  await (data.encryptedExperiments\n    ? instance.setEncryptedExperiments(\n        data.encryptedExperiments,\n        undefined,\n        polyfills.SubtleCrypto\n      )\n    : instance.setExperiments(data.experiments || instance.getExperiments()));\n\n  await (data.encryptedFeatures\n    ? instance.setEncryptedFeatures(\n        data.encryptedFeatures,\n        undefined,\n        polyfills.SubtleCrypto\n      )\n    : instance.setFeatures(data.features || instance.getFeatures()));\n}\n\nasync function fetchFeatures(\n  instance: GrowthBook\n): Promise<FeatureApiResponse> {\n  const [key, apiHost, clientKey] = getKey(instance);\n  const endpoint = apiHost + \"/api/features/\" + clientKey;\n\n  let promise = activeFetches.get(key);\n  if (!promise) {\n    promise = (polyfills.fetch as typeof globalThis.fetch)(endpoint)\n      // TODO: auto-retry if status code indicates a temporary error\n      .then((res) => {\n        if (res.headers.get(\"x-sse-support\") === \"enabled\") {\n          supportsSSE.add(key);\n        }\n        return res.json();\n      })\n      .then((data: FeatureApiResponse) => {\n        onNewFeatureData(key, data);\n        startAutoRefresh(instance);\n        activeFetches.delete(key);\n        return data;\n      })\n      .catch((e) => {\n        process.env.NODE_ENV !== \"production\" &&\n          instance.log(\"Error fetching features\", {\n            apiHost,\n            clientKey,\n            error: e ? e.message : null,\n          });\n        activeFetches.delete(key);\n        return Promise.resolve({});\n      });\n    activeFetches.set(key, promise);\n  }\n  return await promise;\n}\n\n// Watch a feature endpoint for changes\n// Will prefer SSE if enabled, otherwise fall back to cron\nfunction startAutoRefresh(instance: GrowthBook): void {\n  const [key, apiHost, clientKey] = getKey(instance);\n  if (\n    cacheSettings.backgroundSync &&\n    supportsSSE.has(key) &&\n    polyfills.EventSource\n  ) {\n    if (streams.has(key)) return;\n    const channel: ScopedChannel = {\n      src: null,\n      cb: (event: MessageEvent<string>) => {\n        try {\n          const json: FeatureApiResponse = JSON.parse(event.data);\n          onNewFeatureData(key, json);\n          // Reset error count on success\n          channel.errors = 0;\n        } catch (e) {\n          process.env.NODE_ENV !== \"production\" &&\n            instance.log(\"SSE Error\", {\n              apiHost,\n              clientKey,\n              error: e ? (e as Error).message : null,\n            });\n          onSSEError(channel, apiHost, clientKey);\n        }\n      },\n      errors: 0,\n    };\n    streams.set(key, channel);\n    enableChannel(channel, apiHost, clientKey);\n  }\n}\n\nfunction onSSEError(\n  channel: ScopedChannel,\n  apiHost: string,\n  clientKey: string\n) {\n  channel.errors++;\n  if (channel.errors > 3 || (channel.src && channel.src.readyState === 2)) {\n    // exponential backoff after 4 errors, with jitter\n    const delay =\n      Math.pow(3, channel.errors - 3) * (1000 + Math.random() * 1000);\n    disableChannel(channel);\n    setTimeout(() => {\n      enableChannel(channel, apiHost, clientKey);\n    }, Math.min(delay, 300000)); // 5 minutes max\n  }\n}\n\nfunction disableChannel(channel: ScopedChannel) {\n  if (!channel.src) return;\n  channel.src.onopen = null;\n  channel.src.onerror = null;\n  channel.src.close();\n  channel.src = null;\n}\n\nfunction enableChannel(\n  channel: ScopedChannel,\n  apiHost: string,\n  clientKey: string\n) {\n  channel.src = new polyfills.EventSource(\n    `${apiHost}/sub/${clientKey}`\n  ) as EventSource;\n  channel.src.addEventListener(\"features\", channel.cb);\n  channel.src.onerror = () => {\n    onSSEError(channel, apiHost, clientKey);\n  };\n  channel.src.onopen = () => {\n    channel.errors = 0;\n  };\n}\n\nfunction destroyChannel(channel: ScopedChannel, key: RepositoryKey) {\n  disableChannel(channel);\n  streams.delete(key);\n}\n\nfunction clearAutoRefresh() {\n  // Clear list of which keys are auto-updated\n  supportsSSE.clear();\n\n  // Stop listening for any SSE events\n  streams.forEach(destroyChannel);\n\n  // Remove all references to GrowthBook instances\n  subscribedInstances.clear();\n}\n"],"mappings":"AAqBA;AACA,MAAMA,aAA4B,GAAG;EACnC;EACAC,QAAQ,EAAE,IAAI,GAAG,EAAE;EACnBC,QAAQ,EAAE,iBAAiB;EAC3BC,cAAc,EAAE;AAClB,CAAC;AACD,MAAMC,SAAoB,GAAG;EAC3BC,KAAK,EAAEC,UAAU,CAACD,KAAK,GAAGC,UAAU,CAACD,KAAK,CAACE,IAAI,CAACD,UAAU,CAAC,GAAGE,SAAS;EACvEC,YAAY,EAAEH,UAAU,CAACI,MAAM,GAAGJ,UAAU,CAACI,MAAM,CAACC,MAAM,GAAGH,SAAS;EACtEI,WAAW,EAAEN,UAAU,CAACM;AAC1B,CAAC;AACD,IAAI;EACF,IAAIN,UAAU,CAACO,YAAY,EAAE;IAC3BT,SAAS,CAACS,YAAY,GAAGP,UAAU,CAACO,YAAY;EAClD;AACF,CAAC,CAAC,OAAOC,CAAC,EAAE;EACV;AAAA;;AAGF;AACA,MAAMC,mBAAwD,GAAG,IAAIC,GAAG,EAAE;AAC1E,IAAIC,gBAAgB,GAAG,KAAK;AAC5B,MAAMC,KAAqC,GAAG,IAAIF,GAAG,EAAE;AACvD,MAAMG,aAGL,GAAG,IAAIH,GAAG,EAAE;AACb,MAAMI,OAA0C,GAAG,IAAIJ,GAAG,EAAE;AAC5D,MAAMK,WAA+B,GAAG,IAAIC,GAAG,EAAE;;AAEjD;AACA,OAAO,SAASC,YAAY,CAACC,SAA6B,EAAQ;EAChEC,MAAM,CAACC,MAAM,CAACtB,SAAS,EAAEoB,SAAS,CAAC;AACrC;AACA,OAAO,SAASG,cAAc,CAACH,SAAiC,EAAQ;EACtEC,MAAM,CAACC,MAAM,CAAC1B,aAAa,EAAEwB,SAAS,CAAC;EACvC,IAAI,CAACxB,aAAa,CAACG,cAAc,EAAE;IACjCyB,gBAAgB,EAAE;EACpB;AACF;AAEA,OAAO,eAAeC,UAAU,GAAkB;EAChDX,KAAK,CAACY,KAAK,EAAE;EACbX,aAAa,CAACW,KAAK,EAAE;EACrBF,gBAAgB,EAAE;EAClBX,gBAAgB,GAAG,KAAK;EACxB,MAAMc,qBAAqB,EAAE;AAC/B;AAEA,OAAO,eAAeC,eAAe,CACnCC,QAAoB,EACpBC,OAAgB,EAChBC,SAAmB,EACnBC,UAAoB,EACpBC,cAAwB,EACT;EACf,MAAMC,IAAI,GAAG,MAAMC,sBAAsB,CACvCN,QAAQ,EACRG,UAAU,EACVF,OAAO,EACPC,SAAS,CACV;EACDE,cAAc,IAAIC,IAAI,KAAK,MAAME,eAAe,CAACP,QAAQ,EAAEK,IAAI,CAAC,CAAC;AACnE;;AAEA;AACA,OAAO,SAASG,SAAS,CAACR,QAAoB,EAAQ;EACpD,MAAM,CAACS,GAAG,CAAC,GAAGC,MAAM,CAACV,QAAQ,CAAC;EAC9B,MAAMW,IAAI,GAAG7B,mBAAmB,CAAC8B,GAAG,CAACH,GAAG,CAAC,IAAI,IAAIpB,GAAG,EAAE;EACtDsB,IAAI,CAACE,GAAG,CAACb,QAAQ,CAAC;EAClBlB,mBAAmB,CAACgC,GAAG,CAACL,GAAG,EAAEE,IAAI,CAAC;AACpC;AACA,OAAO,SAASI,WAAW,CAACf,QAAoB,EAAQ;EACtDlB,mBAAmB,CAACkC,OAAO,CAAEC,CAAC,IAAKA,CAAC,CAACC,MAAM,CAAClB,QAAQ,CAAC,CAAC;AACxD;;AAEA;AACA,eAAeF,qBAAqB,GAAG;EACrC,IAAI;IACF,IAAI,CAAC3B,SAAS,CAACS,YAAY,EAAE;IAC7B,MAAMT,SAAS,CAACS,YAAY,CAACuC,OAAO,CAClCpD,aAAa,CAACE,QAAQ,EACtBmD,IAAI,CAACC,SAAS,CAACC,KAAK,CAACC,IAAI,CAACtC,KAAK,CAACuC,OAAO,EAAE,CAAC,CAAC,CAC5C;EACH,CAAC,CAAC,OAAO3C,CAAC,EAAE;IACV;EAAA;AAEJ;AAEA,eAAeyB,sBAAsB,CACnCN,QAAoB,EACpBG,UAAoB,EACpBF,OAAgB,EAChBC,SAAmB,EACiB;EACpC,MAAM,CAACO,GAAG,CAAC,GAAGC,MAAM,CAACV,QAAQ,CAAC;EAC9B,MAAMyB,GAAG,GAAG,IAAIC,IAAI,EAAE;EACtB,MAAMC,eAAe,EAAE;EACvB,MAAMC,QAAQ,GAAG3C,KAAK,CAAC2B,GAAG,CAACH,GAAG,CAAC;EAC/B,IAAImB,QAAQ,IAAI,CAAC1B,SAAS,KAAKC,UAAU,IAAIyB,QAAQ,CAACC,OAAO,GAAGJ,GAAG,CAAC,EAAE;IACpE;IACA,IAAIG,QAAQ,CAACC,OAAO,GAAGJ,GAAG,EAAE;MAC1BK,aAAa,CAAC9B,QAAQ,CAAC;IACzB;IACA;IAAA,KACK;MACH+B,gBAAgB,CAAC/B,QAAQ,CAAC;IAC5B;IACA,OAAO4B,QAAQ,CAACvB,IAAI;EACtB,CAAC,MAAM;IACL,MAAMA,IAAI,GAAG,MAAM2B,cAAc,CAACF,aAAa,CAAC9B,QAAQ,CAAC,EAAEC,OAAO,CAAC;IACnE,OAAOI,IAAI;EACb;AACF;AAEA,SAASK,MAAM,CAACV,QAAoB,EAAuC;EACzE,MAAM,CAACiC,OAAO,EAAEC,SAAS,CAAC,GAAGlC,QAAQ,CAACmC,UAAU,EAAE;EAClD,OAAO,WAAIF,OAAO,eAAKC,SAAS,GAAID,OAAO,EAAEC,SAAS,CAAC;AACzD;;AAEA;AACA;AACA;AACA,SAASF,cAAc,CACrBI,OAAmB,EACnBnC,OAAgB,EACG;EACnB,OAAO,IAAIoC,OAAO,CAAEC,OAAO,IAAK;IAC9B,IAAIC,QAAQ,GAAG,KAAK;IACpB,IAAIC,KAAc;IAClB,MAAMC,MAAM,GAAIpC,IAAQ,IAAK;MAC3B,IAAIkC,QAAQ,EAAE;MACdA,QAAQ,GAAG,IAAI;MACfC,KAAK,IAAIE,YAAY,CAACF,KAAK,CAAiB;MAC5CF,OAAO,CAACjC,IAAI,IAAI,IAAI,CAAC;IACvB,CAAC;IAED,IAAIJ,OAAO,EAAE;MACXuC,KAAK,GAAGG,UAAU,CAAC,MAAMF,MAAM,EAAE,EAAExC,OAAO,CAAC;IAC7C;IAEAmC,OAAO,CAACQ,IAAI,CAAEvC,IAAI,IAAKoC,MAAM,CAACpC,IAAI,CAAC,CAAC,CAACwC,KAAK,CAAC,MAAMJ,MAAM,EAAE,CAAC;EAC5D,CAAC,CAAC;AACJ;;AAEA;AACA,eAAed,eAAe,GAAkB;EAC9C,IAAI3C,gBAAgB,EAAE;EACtBA,gBAAgB,GAAG,IAAI;EACvB,IAAI;IACF,IAAIb,SAAS,CAACS,YAAY,EAAE;MAC1B,MAAMkE,KAAK,GAAG,MAAM3E,SAAS,CAACS,YAAY,CAACmE,OAAO,CAChDhF,aAAa,CAACE,QAAQ,CACvB;MACD,IAAI6E,KAAK,EAAE;QACT,MAAME,MAAqC,GAAG5B,IAAI,CAAC6B,KAAK,CAACH,KAAK,CAAC;QAC/D,IAAIE,MAAM,IAAI1B,KAAK,CAAC4B,OAAO,CAACF,MAAM,CAAC,EAAE;UACnCA,MAAM,CAAChC,OAAO,CAAC,QAAiB;YAAA,IAAhB,CAACP,GAAG,EAAEJ,IAAI,CAAC;YACzBpB,KAAK,CAAC6B,GAAG,CAACL,GAAG,EAAE;cACb,GAAGJ,IAAI;cACPwB,OAAO,EAAE,IAAIH,IAAI,CAACrB,IAAI,CAACwB,OAAO;YAChC,CAAC,CAAC;UACJ,CAAC,CAAC;QACJ;MACF;IACF;EACF,CAAC,CAAC,OAAOhD,CAAC,EAAE;IACV;EAAA;AAEJ;;AAEA;AACA,SAASsE,gBAAgB,CAAC1C,GAAkB,EAAEJ,IAAwB,EAAQ;EAC5E;EACA,MAAM+C,OAAO,GAAG/C,IAAI,CAACgD,WAAW,IAAI,EAAE;EACtC,MAAMxB,OAAO,GAAG,IAAIH,IAAI,CAACA,IAAI,CAACD,GAAG,EAAE,GAAG1D,aAAa,CAACC,QAAQ,CAAC;EAC7D,MAAM4D,QAAQ,GAAG3C,KAAK,CAAC2B,GAAG,CAACH,GAAG,CAAC;EAC/B,IAAImB,QAAQ,IAAIwB,OAAO,IAAIxB,QAAQ,CAACwB,OAAO,KAAKA,OAAO,EAAE;IACvDxB,QAAQ,CAACC,OAAO,GAAGA,OAAO;IAC1B;EACF;;EAEA;EACA5C,KAAK,CAAC6B,GAAG,CAACL,GAAG,EAAE;IACbJ,IAAI;IACJ+C,OAAO;IACPvB;EACF,CAAC,CAAC;EACF;EACA/B,qBAAqB,EAAE;;EAEvB;EACA,MAAMwD,SAAS,GAAGxE,mBAAmB,CAAC8B,GAAG,CAACH,GAAG,CAAC;EAC9C6C,SAAS,IAAIA,SAAS,CAACtC,OAAO,CAAEhB,QAAQ,IAAKO,eAAe,CAACP,QAAQ,EAAEK,IAAI,CAAC,CAAC;AAC/E;AAEA,eAAeE,eAAe,CAC5BP,QAAoB,EACpBK,IAAwB,EACT;EACf,OAAOA,IAAI,CAACkD,oBAAoB,GAC5BvD,QAAQ,CAACwD,uBAAuB,CAC9BnD,IAAI,CAACkD,oBAAoB,EACzBhF,SAAS,EACTJ,SAAS,CAACK,YAAY,CACvB,GACDwB,QAAQ,CAACyD,cAAc,CAACpD,IAAI,CAACqD,WAAW,IAAI1D,QAAQ,CAAC2D,cAAc,EAAE,CAAC,CAAC;EAE3E,OAAOtD,IAAI,CAACuD,iBAAiB,GACzB5D,QAAQ,CAAC6D,oBAAoB,CAC3BxD,IAAI,CAACuD,iBAAiB,EACtBrF,SAAS,EACTJ,SAAS,CAACK,YAAY,CACvB,GACDwB,QAAQ,CAAC8D,WAAW,CAACzD,IAAI,CAAC0D,QAAQ,IAAI/D,QAAQ,CAACgE,WAAW,EAAE,CAAC,CAAC;AACpE;AAEA,eAAelC,aAAa,CAC1B9B,QAAoB,EACS;EAC7B,MAAM,CAACS,GAAG,EAAEwB,OAAO,EAAEC,SAAS,CAAC,GAAGxB,MAAM,CAACV,QAAQ,CAAC;EAClD,MAAMiE,QAAQ,GAAGhC,OAAO,GAAG,gBAAgB,GAAGC,SAAS;EAEvD,IAAIE,OAAO,GAAGlD,aAAa,CAAC0B,GAAG,CAACH,GAAG,CAAC;EACpC,IAAI,CAAC2B,OAAO,EAAE;IACZA,OAAO,GAAIjE,SAAS,CAACC,KAAK,CAA6B6F,QAAQ;IAC7D;IAAA,CACCrB,IAAI,CAAEsB,GAAG,IAAK;MACb,IAAIA,GAAG,CAACC,OAAO,CAACvD,GAAG,CAAC,eAAe,CAAC,KAAK,SAAS,EAAE;QAClDxB,WAAW,CAACyB,GAAG,CAACJ,GAAG,CAAC;MACtB;MACA,OAAOyD,GAAG,CAACE,IAAI,EAAE;IACnB,CAAC,CAAC,CACDxB,IAAI,CAAEvC,IAAwB,IAAK;MAClC8C,gBAAgB,CAAC1C,GAAG,EAAEJ,IAAI,CAAC;MAC3B0B,gBAAgB,CAAC/B,QAAQ,CAAC;MAC1Bd,aAAa,CAACgC,MAAM,CAACT,GAAG,CAAC;MACzB,OAAOJ,IAAI;IACb,CAAC,CAAC,CACDwC,KAAK,CAAEhE,CAAC,IAAK;MACZwF,OAAO,CAACC,GAAG,CAACC,QAAQ,KAAK,YAAY,IACnCvE,QAAQ,CAACwE,GAAG,CAAC,yBAAyB,EAAE;QACtCvC,OAAO;QACPC,SAAS;QACTuC,KAAK,EAAE5F,CAAC,GAAGA,CAAC,CAAC6F,OAAO,GAAG;MACzB,CAAC,CAAC;MACJxF,aAAa,CAACgC,MAAM,CAACT,GAAG,CAAC;MACzB,OAAO4B,OAAO,CAACC,OAAO,CAAC,CAAC,CAAC,CAAC;IAC5B,CAAC,CAAC;IACJpD,aAAa,CAAC4B,GAAG,CAACL,GAAG,EAAE2B,OAAO,CAAC;EACjC;EACA,OAAO,MAAMA,OAAO;AACtB;;AAEA;AACA;AACA,SAASL,gBAAgB,CAAC/B,QAAoB,EAAQ;EACpD,MAAM,CAACS,GAAG,EAAEwB,OAAO,EAAEC,SAAS,CAAC,GAAGxB,MAAM,CAACV,QAAQ,CAAC;EAClD,IACEjC,aAAa,CAACG,cAAc,IAC5BkB,WAAW,CAACuF,GAAG,CAAClE,GAAG,CAAC,IACpBtC,SAAS,CAACQ,WAAW,EACrB;IACA,IAAIQ,OAAO,CAACwF,GAAG,CAAClE,GAAG,CAAC,EAAE;IACtB,MAAMmE,OAAsB,GAAG;MAC7BC,GAAG,EAAE,IAAI;MACTC,EAAE,EAAGC,KAA2B,IAAK;QACnC,IAAI;UACF,MAAMX,IAAwB,GAAGhD,IAAI,CAAC6B,KAAK,CAAC8B,KAAK,CAAC1E,IAAI,CAAC;UACvD8C,gBAAgB,CAAC1C,GAAG,EAAE2D,IAAI,CAAC;UAC3B;UACAQ,OAAO,CAACI,MAAM,GAAG,CAAC;QACpB,CAAC,CAAC,OAAOnG,CAAC,EAAE;UACVwF,OAAO,CAACC,GAAG,CAACC,QAAQ,KAAK,YAAY,IACnCvE,QAAQ,CAACwE,GAAG,CAAC,WAAW,EAAE;YACxBvC,OAAO;YACPC,SAAS;YACTuC,KAAK,EAAE5F,CAAC,GAAIA,CAAC,CAAW6F,OAAO,GAAG;UACpC,CAAC,CAAC;UACJO,UAAU,CAACL,OAAO,EAAE3C,OAAO,EAAEC,SAAS,CAAC;QACzC;MACF,CAAC;MACD8C,MAAM,EAAE;IACV,CAAC;IACD7F,OAAO,CAAC2B,GAAG,CAACL,GAAG,EAAEmE,OAAO,CAAC;IACzBM,aAAa,CAACN,OAAO,EAAE3C,OAAO,EAAEC,SAAS,CAAC;EAC5C;AACF;AAEA,SAAS+C,UAAU,CACjBL,OAAsB,EACtB3C,OAAe,EACfC,SAAiB,EACjB;EACA0C,OAAO,CAACI,MAAM,EAAE;EAChB,IAAIJ,OAAO,CAACI,MAAM,GAAG,CAAC,IAAKJ,OAAO,CAACC,GAAG,IAAID,OAAO,CAACC,GAAG,CAACM,UAAU,KAAK,CAAE,EAAE;IACvE;IACA,MAAMC,KAAK,GACTC,IAAI,CAACC,GAAG,CAAC,CAAC,EAAEV,OAAO,CAACI,MAAM,GAAG,CAAC,CAAC,IAAI,IAAI,GAAGK,IAAI,CAACE,MAAM,EAAE,GAAG,IAAI,CAAC;IACjEC,cAAc,CAACZ,OAAO,CAAC;IACvBjC,UAAU,CAAC,MAAM;MACfuC,aAAa,CAACN,OAAO,EAAE3C,OAAO,EAAEC,SAAS,CAAC;IAC5C,CAAC,EAAEmD,IAAI,CAACI,GAAG,CAACL,KAAK,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC;EAC/B;AACF;;AAEA,SAASI,cAAc,CAACZ,OAAsB,EAAE;EAC9C,IAAI,CAACA,OAAO,CAACC,GAAG,EAAE;EAClBD,OAAO,CAACC,GAAG,CAACa,MAAM,GAAG,IAAI;EACzBd,OAAO,CAACC,GAAG,CAACc,OAAO,GAAG,IAAI;EAC1Bf,OAAO,CAACC,GAAG,CAACe,KAAK,EAAE;EACnBhB,OAAO,CAACC,GAAG,GAAG,IAAI;AACpB;AAEA,SAASK,aAAa,CACpBN,OAAsB,EACtB3C,OAAe,EACfC,SAAiB,EACjB;EACA0C,OAAO,CAACC,GAAG,GAAG,IAAI1G,SAAS,CAACQ,WAAW,WAClCsD,OAAO,kBAAQC,SAAS,EACb;EAChB0C,OAAO,CAACC,GAAG,CAACgB,gBAAgB,CAAC,UAAU,EAAEjB,OAAO,CAACE,EAAE,CAAC;EACpDF,OAAO,CAACC,GAAG,CAACc,OAAO,GAAG,MAAM;IAC1BV,UAAU,CAACL,OAAO,EAAE3C,OAAO,EAAEC,SAAS,CAAC;EACzC,CAAC;EACD0C,OAAO,CAACC,GAAG,CAACa,MAAM,GAAG,MAAM;IACzBd,OAAO,CAACI,MAAM,GAAG,CAAC;EACpB,CAAC;AACH;AAEA,SAASc,cAAc,CAAClB,OAAsB,EAAEnE,GAAkB,EAAE;EAClE+E,cAAc,CAACZ,OAAO,CAAC;EACvBzF,OAAO,CAAC+B,MAAM,CAACT,GAAG,CAAC;AACrB;AAEA,SAASd,gBAAgB,GAAG;EAC1B;EACAP,WAAW,CAACS,KAAK,EAAE;;EAEnB;EACAV,OAAO,CAAC6B,OAAO,CAAC8E,cAAc,CAAC;;EAE/B;EACAhH,mBAAmB,CAACe,KAAK,EAAE;AAC7B"}